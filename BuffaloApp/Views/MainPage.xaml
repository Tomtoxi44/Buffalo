<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:BuffaloApp.ViewModels"
             xmlns:models="clr-namespace:BuffaloApp.Models"
             x:Class="BuffaloApp.Views.MainPage"
             x:DataType="vm:MainViewModel"
             Title="Buffalo"
             BackgroundColor="{AppThemeBinding Light={StaticResource LightBackground}, Dark={StaticResource DarkBackground}}">

    <Grid RowDefinitions="Auto,Auto,*,Auto" Padding="20">
        
        <!-- Header avec stats -->
        <Frame Grid.Row="0" 
               BackgroundColor="{AppThemeBinding Light={StaticResource LightCardBg}, Dark={StaticResource DarkCardBg}}" 
               CornerRadius="15" 
               Padding="20"
               BorderColor="Transparent"
               HasShadow="True">
            <Frame.Shadow>
                <Shadow Brush="{AppThemeBinding Light=#40000000, Dark=Transparent}" 
                        Offset="0,2" 
                        Radius="8" 
                        Opacity="0.15"/>
            </Frame.Shadow>
            <Grid ColumnDefinitions="*,Auto">
                <VerticalStackLayout>
                    <Label Text="ðŸ¦¬ Buffalo Mode" 
                           FontSize="24" 
                           FontAttributes="Bold"
                           TextColor="{AppThemeBinding Light={StaticResource LightTextPrimary}, Dark={StaticResource DarkTextPrimary}}"/>
                    <Label Text="{Binding StatusMessage}" 
                           FontSize="14" 
                           TextColor="{AppThemeBinding Light={StaticResource LightTextSecondary}, Dark={StaticResource DarkTextSecondary}}"
                           Margin="0,5,0,0"/>
                </VerticalStackLayout>
                
                <Switch Grid.Column="1" 
                        IsToggled="{Binding IsPlaying}"
                        OnColor="#e94560"
                        ThumbColor="White"
                        VerticalOptions="Center"
                        Toggled="OnBuffaloModeToggled"/>
            </Grid>
        </Frame>

        <!-- Stats rapides -->
        <Grid Grid.Row="1" 
              ColumnDefinitions="*,*,*,*" 
              Margin="0,15,0,0"
              ColumnSpacing="10">
            
            <Frame BackgroundColor="{AppThemeBinding Light={StaticResource LightCardBg}, Dark={StaticResource DarkCardBg}}" 
                   CornerRadius="10" 
                   Padding="10" 
                   BorderColor="Transparent"
                   HasShadow="True">
                <Frame.Shadow>
                    <Shadow Brush="{AppThemeBinding Light=#40000000, Dark=Transparent}" 
                            Offset="0,2" 
                            Radius="6" 
                            Opacity="0.1"/>
                </Frame.Shadow>
                <VerticalStackLayout HorizontalOptions="Center">
                    <Label Text="{Binding BuffaloGiven}" 
                           FontSize="24" 
                           FontAttributes="Bold"
                           TextColor="{StaticResource BuffaloGreen}"
                           HorizontalOptions="Center"/>
                    <Label Text="DonnÃ©s" 
                           FontSize="10" 
                           TextColor="{AppThemeBinding Light={StaticResource LightTextSecondary}, Dark={StaticResource DarkTextSecondary}}"
                           HorizontalOptions="Center"/>
                </VerticalStackLayout>
            </Frame>
            
            <Frame Grid.Column="1" 
                   BackgroundColor="{AppThemeBinding Light={StaticResource LightCardBg}, Dark={StaticResource DarkCardBg}}" 
                   CornerRadius="10" 
                   Padding="10" 
                   BorderColor="Transparent"
                   HasShadow="True">
                <Frame.Shadow>
                    <Shadow Brush="{AppThemeBinding Light=#40000000, Dark=Transparent}" 
                            Offset="0,2" 
                            Radius="6" 
                            Opacity="0.1"/>
                </Frame.Shadow>
                <VerticalStackLayout HorizontalOptions="Center">
                    <Label Text="{Binding BuffaloReceived}" 
                           FontSize="24" 
                           FontAttributes="Bold"
                           TextColor="{StaticResource BuffaloRed}"
                           HorizontalOptions="Center"/>
                    <Label Text="ReÃ§us" 
                           FontSize="10" 
                           TextColor="{AppThemeBinding Light={StaticResource LightTextSecondary}, Dark={StaticResource DarkTextSecondary}}"
                           HorizontalOptions="Center"/>
                </VerticalStackLayout>
            </Frame>
            
            <Frame Grid.Column="2" 
                   BackgroundColor="{AppThemeBinding Light={StaticResource LightCardBg}, Dark={StaticResource DarkCardBg}}" 
                   CornerRadius="10" 
                   Padding="10" 
                   BorderColor="Transparent"
                   HasShadow="True">
                <Frame.Shadow>
                    <Shadow Brush="{AppThemeBinding Light=#40000000, Dark=Transparent}" 
                            Offset="0,2" 
                            Radius="6" 
                            Opacity="0.1"/>
                </Frame.Shadow>
                <VerticalStackLayout HorizontalOptions="Center">
                    <Label Text="{Binding SlateOwedToYou}" 
                           FontSize="24" 
                           FontAttributes="Bold"
                           TextColor="{StaticResource BuffaloYellow}"
                           HorizontalOptions="Center"/>
                    <Label Text="Ã€ rÃ©cup" 
                           FontSize="10" 
                           TextColor="{AppThemeBinding Light={StaticResource LightTextSecondary}, Dark={StaticResource DarkTextSecondary}}"
                           HorizontalOptions="Center"/>
                </VerticalStackLayout>
            </Frame>
            
            <Frame Grid.Column="3" 
                   BackgroundColor="{AppThemeBinding Light={StaticResource LightCardBg}, Dark={StaticResource DarkCardBg}}" 
                   CornerRadius="10" 
                   Padding="10" 
                   BorderColor="Transparent"
                   HasShadow="True">
                <Frame.Shadow>
                    <Shadow Brush="{AppThemeBinding Light=#40000000, Dark=Transparent}" 
                            Offset="0,2" 
                            Radius="6" 
                            Opacity="0.1"/>
                </Frame.Shadow>
                <VerticalStackLayout HorizontalOptions="Center">
                    <Label Text="{Binding SlateOwed}" 
                           FontSize="24" 
                           FontAttributes="Bold"
                           TextColor="#ff6b6b"
                           HorizontalOptions="Center"/>
                    <Label Text="Ã€ payer" 
                           FontSize="10" 
                           TextColor="{AppThemeBinding Light={StaticResource LightTextSecondary}, Dark={StaticResource DarkTextSecondary}}"
                           HorizontalOptions="Center"/>
                </VerticalStackLayout>
            </Frame>
        </Grid>

        <!-- Liste des joueurs Ã  proximitÃ© -->
        <Frame Grid.Row="2" 
               BackgroundColor="{AppThemeBinding Light={StaticResource LightCardBg}, Dark={StaticResource DarkCardBg}}" 
               CornerRadius="15" 
               Padding="15"
               Margin="0,15,0,0"
               BorderColor="Transparent"
               HasShadow="True">
            <Frame.Shadow>
                <Shadow Brush="{AppThemeBinding Light=#40000000, Dark=Transparent}" 
                        Offset="0,2" 
                        Radius="8" 
                        Opacity="0.15"/>
            </Frame.Shadow>
            <Grid RowDefinitions="Auto,*">
                <HorizontalStackLayout>
                    <Label Text="ðŸ“ Joueurs Ã  proximitÃ©" 
                           FontSize="18" 
                           FontAttributes="Bold"
                           TextColor="{AppThemeBinding Light={StaticResource LightTextPrimary}, Dark={StaticResource DarkTextPrimary}}"/>
                    <Label Text="{Binding NearbyPlayersCount, StringFormat=' ({0})'}" 
                           FontSize="18" 
                           TextColor="{AppThemeBinding Light={StaticResource LightTextSecondary}, Dark={StaticResource DarkTextSecondary}}"/>
                </HorizontalStackLayout>

                <CollectionView Grid.Row="1" 
                                ItemsSource="{Binding NearbyPlayers}"
                                Margin="0,10,0,0">
                    <CollectionView.EmptyView>
                        <VerticalStackLayout VerticalOptions="Center" 
                                             HorizontalOptions="Center"
                                             Padding="20">
                            <Label Text="ðŸ”" FontSize="48" HorizontalOptions="Center"/>
                            <Label Text="{Binding IsPlaying, Converter={StaticResource BoolToSearchTextConverter}}"
                                   FontSize="14"
                                   TextColor="{AppThemeBinding Light={StaticResource LightTextSecondary}, Dark={StaticResource DarkTextSecondary}}"
                                   HorizontalOptions="Center"
                                   HorizontalTextAlignment="Center"/>
                        </VerticalStackLayout>
                    </CollectionView.EmptyView>
                    
                    <CollectionView.ItemTemplate>
                        <DataTemplate x:DataType="models:NearbyPlayer">
                            <Frame BackgroundColor="{AppThemeBinding Light={StaticResource LightCardSecondary}, Dark={StaticResource DarkCardSecondary}}" 
                                   CornerRadius="10" 
                                   Padding="15"
                                   Margin="0,5"
                                   BorderColor="Transparent"
                                   HasShadow="True">
                                <Frame.Shadow>
                                    <Shadow Brush="{AppThemeBinding Light=#40000000, Dark=Transparent}" 
                                            Offset="0,2" 
                                            Radius="6" 
                                            Opacity="0.1"/>
                                </Frame.Shadow>
                                <Grid ColumnDefinitions="Auto,*,Auto" ColumnSpacing="15">
                                    <Frame BackgroundColor="{StaticResource BuffaloRed}" 
                                           CornerRadius="25" 
                                           WidthRequest="50" 
                                           HeightRequest="50"
                                           Padding="0"
                                           BorderColor="Transparent">
                                        <Label Text="ðŸ¦¬" 
                                               FontSize="24" 
                                               VerticalOptions="Center"
                                               HorizontalOptions="Center"/>
                                    </Frame>
                                    
                                    <VerticalStackLayout Grid.Column="1" VerticalOptions="Center">
                                        <Label Text="{Binding Player.Pseudo}" 
                                               FontSize="16" 
                                               FontAttributes="Bold"
                                               TextColor="{AppThemeBinding Light={StaticResource LightTextPrimary}, Dark={StaticResource DarkTextPrimary}}"/>
                                        <Label Text="{Binding DistanceDescription}" 
                                               FontSize="12" 
                                               TextColor="{AppThemeBinding Light={StaticResource LightTextSecondary}, Dark={StaticResource DarkTextSecondary}}"/>
                                        <HorizontalStackLayout Spacing="10" IsVisible="{Binding SlateOwedToYou, Converter={StaticResource IntToBoolConverter}}">
                                            <Label Text="ðŸ“" FontSize="12"/>
                                            <Label Text="{Binding SlateOwedToYou, StringFormat='Ardoise: {0}'}" 
                                                   FontSize="12" 
                                                   TextColor="{StaticResource BuffaloYellow}"/>
                                        </HorizontalStackLayout>
                                    </VerticalStackLayout>
                                    
                                    <VerticalStackLayout Grid.Column="2" Spacing="5">
                                        <Button Text="BUFFALO!"
                                                BackgroundColor="{StaticResource BuffaloRed}"
                                                TextColor="White"
                                                FontAttributes="Bold"
                                                CornerRadius="8"
                                                Padding="15,8"
                                                Command="{Binding Source={RelativeSource AncestorType={x:Type vm:MainViewModel}}, Path=GiveBuffaloCommand}"
                                                CommandParameter="{Binding .}"/>
                                        
                                        <Button Text="Ardoise"
                                                BackgroundColor="{StaticResource BuffaloYellow}"
                                                TextColor="{AppThemeBinding Light={StaticResource LightTextPrimary}, Dark=#1a1a2e}"
                                                CornerRadius="8"
                                                Padding="15,5"
                                                FontSize="12"
                                                IsVisible="{Binding SlateOwedToYou, Converter={StaticResource IntToBoolConverter}}"
                                                Command="{Binding Source={RelativeSource AncestorType={x:Type vm:MainViewModel}}, Path=SettleSlateCommand}"
                                                CommandParameter="{Binding .}"/>
                                    </VerticalStackLayout>
                                </Grid>
                            </Frame>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                </CollectionView>
            </Grid>
        </Frame>

        <!-- Indicateur de scan -->
        <HorizontalStackLayout Grid.Row="3" 
                                HorizontalOptions="Center" 
                                Margin="0,10,0,0"
                                IsVisible="{Binding IsScanning}">
            <ActivityIndicator IsRunning="{Binding IsScanning}" 
                               Color="{StaticResource BuffaloGreen}"
                               WidthRequest="20"
                               HeightRequest="20"/>
            <Label Text=" Recherche en cours..." 
                   TextColor="{StaticResource BuffaloGreen}" 
                   FontSize="12"
                   VerticalOptions="Center"/>
        </HorizontalStackLayout>
    </Grid>
</ContentPage>
